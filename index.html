<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø¢Ø¯Ù…Ù† - Ù†Ø§Ø¯ÙŠ Ø§Ù‚Ø±Ø£</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        /* --- Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ§Øª --- */
        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body { background-color: #fcf8ec; color: #5d4037; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* --- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ --- */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #2d1b00, #1a1a1a);
            display: flex; justify-content: center; align-items: center; z-index: 2000;
        }
        .login-box {
            background: #fcf8ec; padding: 30px; border-radius: 20px;
            width: 85%; max-width: 400px; text-align: center;
            border: 4px solid #cfaa56; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .login-title { color: #a17506; font-weight: 900; margin-bottom: 20px; font-size: 1.4rem; }
        .form-input {
            width: 100%; padding: 12px; margin-bottom: 15px;
            border: 1px solid #cfaa56; border-radius: 8px; outline: none; font-size: 16px;
        }
        .login-btn {
            width: 100%; padding: 12px; background: #a17506; color: white;
            border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.3s; font-size: 16px;
        }
        .error-msg { color: red; font-size: 0.8rem; display: none; margin-bottom: 10px; }

        /* --- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… (Dashboard) --- */
        #dashboard { flex: 1; display: none; height: 100%; overflow: hidden; } 
        
        /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© (Sidebar / Topbar) */
        .sidebar {
            width: 250px; background: #2d1b00; color: #fcf8ec;
            display: flex; flex-direction: column; padding: 20px;
            flex-shrink: 0; z-index: 100;
        }
        .admin-logo {
            font-size: 1.5rem; font-weight: 900; color: #cfaa56;
            text-align: center; margin-bottom: 30px; border-bottom: 1px solid #444; padding-bottom: 20px;
        }
        .menu-item {
            padding: 12px 15px; cursor: pointer; border-radius: 10px; margin-bottom: 10px;
            transition: 0.3s; font-weight: 600; white-space: nowrap; font-size: 1rem;
            display: flex; align-items: center; gap: 10px;
        }
        .menu-item:hover, .menu-item.active { background: #cfaa56; color: #2d1b00; }
        .logout-btn { margin-top: auto; background: #d32f2f; color: white; justify-content: center; }

        /* Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; background-color: #fcf8ec; position: relative; }
        .section-title { font-size: 1.8rem; color: #a17506; margin-bottom: 25px; font-weight: 900; }
        
        /* Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ (Ø³Ø·Ø­ Ø§Ù„Ù…ÙƒØªØ¨) */
        .table-container { overflow-x: auto; background: white; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .data-table { width: 100%; border-collapse: collapse; min-width: 600px; }
        .data-table th, .data-table td { padding: 15px; text-align: right; border-bottom: 1px solid #eee; vertical-align: middle; }
        .data-table th { background: #f7f1e1; color: #a17506; font-weight: 800; }
        
        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª */
        .add-book-btn {
            background: #a17506; color: white; padding: 12px 25px; 
            border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-bottom: 20px; 
            display: inline-block; font-size: 1rem; box-shadow: 0 4px 6px rgba(161, 117, 6, 0.2);
        }
        .action-btn { padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; font-size: 0.85rem; margin-left: 5px; color: white; }
        .btn-edit { background: #2196F3; }
        .btn-delete { background: #d32f2f; }

        /* Ø§Ù„Ø£Ù‚Ø³Ø§Ù… */
        .content-section { display: none; }
        .content-section.active { display: block; padding-bottom: 50px; }

        /* Loading Spinner */
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #a17506; border-radius: 50%;
            width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 30px auto; display: none;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Modal */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 3000;
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background: #fff; padding: 25px; border-radius: 15px; width: 450px;
            border: 2px solid #cfaa56; position: relative; max-height: 90vh; overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .modal-header { font-weight: 900; font-size: 1.3rem; color: #a17506; margin-bottom: 20px; text-align: center; }
        .modal-footer { margin-top: 25px; display: flex; gap: 10px; }
        .cancel-btn { background: #e0e0e0; color: #333; }

        /* ========================================= */
        /* === ØªØ®ØµÙŠØµØ§Øª Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ (Responsive CSS) === */
        /* ========================================= */
        @media (max-width: 768px) {
            body { height: 100%; overflow: auto; } /* Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨ØªÙ…Ø±ÙŠØ± Ø§Ù„ØµÙØ­Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ */
            #dashboard { display: none; flex-direction: column; height: auto; overflow: visible; }
            
            /* --- ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ù„Ø´Ø±ÙŠØ· Ø¹Ù„ÙˆÙŠ --- */
            .sidebar { 
                position: sticky; /* ØªØ«Ø¨ÙŠØª ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰ */
                top: 0;
                width: 100%; 
                height: auto; 
                flex-direction: row; 
                overflow-x: auto; /* Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø£ÙÙ‚ÙŠ */
                padding: 10px 15px; 
                align-items: center;
                background: #2d1b00;
                box-shadow: 0 4px 10px rgba(0,0,0,0.2);
                gap: 10px;
                /* Ø¥Ø®ÙØ§Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± */
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
            .sidebar::-webkit-scrollbar { display: none; }
            
            .admin-logo { display: none; } /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø´Ø¹Ø§Ø± Ø§Ù„ÙƒØ¨ÙŠØ± */
            
            .menu-item { 
                margin: 0; 
                padding: 8px 16px;
                font-size: 0.9rem; 
                border-radius: 20px; /* Ø´ÙƒÙ„ ÙƒØ¨Ø³ÙˆÙ„Ø© */
                background: rgba(255,255,255,0.1);
                flex-shrink: 0; /* Ù…Ù†Ø¹ Ø§Ù„Ø§Ù†ÙƒÙ…Ø§Ø´ */
            }
            .menu-item.active { background: #cfaa56; color: #2d1b00; box-shadow: 0 0 10px #cfaa56; }
            
            .logout-btn { 
                margin-top: 0; 
                background: #d32f2f;
                margin-right: auto; /* Ø¯ÙØ¹ Ø§Ù„Ø²Ø± Ù„Ù„ÙŠØ³Ø§Ø± Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù…Ø³Ø§Ø­Ø© */
            }

            /* --- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ --- */
            .main-content { padding: 15px; overflow: visible; }
            .section-title { font-size: 1.5rem; text-align: center; margin-bottom: 20px; }
            .add-book-btn { width: 100%; text-align: center; padding: 15px; font-size: 1.1rem; }

            /* --- ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¥Ù„Ù‰ Ø¨Ø·Ø§Ù‚Ø§Øª (Cards) --- */
            .table-container { background: transparent; box-shadow: none; overflow: visible; }
            .data-table { display: block; width: 100%; min-width: 0; }
            .data-table thead { display: none; } /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† */
            
            .data-table tbody { display: block; width: 100%; }
            
            .data-table tr { 
                display: block;
                margin-bottom: 20px; 
                background: #fff; 
                border: 1px solid #e0d0a0; 
                border-radius: 15px; 
                box-shadow: 0 4px 10px rgba(0,0,0,0.05); 
                padding: 15px;
                position: relative;
            }
            
            .data-table td { 
                display: flex; 
                justify-content: space-between; 
                align-items: center;
                text-align: left;
                padding: 10px 0; 
                border-bottom: 1px solid #f0f0f0; 
                font-size: 0.95rem;
                width: 100%;
            }
            
            /* Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ */
            .data-table td::before { 
                content: attr(data-label); 
                font-weight: 700; 
                color: #a17506; 
                margin-left: 15px;
            }
            
            .data-table td:last-child { 
                border-bottom: none; 
                padding-top: 15px;
                justify-content: center;
                gap: 10px;
            }
            .data-table td:first-child { border-top: none; padding-top: 0; }

            /* ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙÙŠ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
            .action-btn { flex: 1; padding: 12px; font-size: 1rem; }

            /* Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ */
            .modal-content { width: 90%; margin: auto; max-height: 85vh; }
        }

    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <div class="login-title">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ† ğŸ”’</div>
            <p class="error-msg" id="login-error">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>
            <input type="text" id="username" class="form-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
            <input type="password" id="password" class="form-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <button class="login-btn" onclick="checkLogin()">Ø¯Ø®ÙˆÙ„</button>
        </div>
    </div>

    <div id="dashboard">
        
        <div class="sidebar">
            <div class="admin-logo">Admin</div>
            <div class="menu-item active" onclick="showSection('orders')">ğŸ“¦ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
            <div class="menu-item" onclick="showSection('books')">ğŸ“š Ø§Ù„Ø¨ÙŠØ¹</div>
            <div class="menu-item" onclick="showSection('borrow')">ğŸ¤ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø±Ø©</div>
            <div class="menu-item" onclick="showSection('share')">ğŸ“¢ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ§Øª</div>
            <div class="menu-item logout-btn" onclick="logout()">Ø®Ø±ÙˆØ¬</div>
        </div>

        <div class="main-content">
            
            <div id="orders-section" class="content-section active">
                <h2 class="section-title">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</h2>
                <div class="loader" id="orders-loader"></div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                <th>Ø§Ù„Ø§Ø³Ù…</th>
                                <th>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</th>
                                <th>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠ</th>
                                <th>Ø§Ù„ÙƒØªØ¨ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</th>
                                <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="books-section" class="content-section">
                <h2 class="section-title">Ø¥Ø¯Ø§Ø±Ø© ÙƒØªØ¨ Ø§Ù„Ø¨ÙŠØ¹</h2>
                <button class="add-book-btn" onclick="openAddBookModal('sale')">+ Ø¥Ø¶Ø§ÙØ© ÙƒØªØ§Ø¨ Ø¬Ø¯ÙŠØ¯</button>
                <div class="loader" id="books-loader"></div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ØµÙˆØ±Ø©</th>
                                <th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
                                <th>Ø§Ù„Ø³Ø¹Ø±</th>
                                <th>Ø§Ù„ØªØµÙ†ÙŠÙ</th>
                                <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="books-table-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="borrow-section" class="content-section">
                <h2 class="section-title">Ø¥Ø¯Ø§Ø±Ø© ÙƒØªØ¨ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø±Ø©</h2>
                <button class="add-book-btn" onclick="openAddBookModal('borrow')">+ Ø¥Ø¶Ø§ÙØ© ÙƒØªØ§Ø¨ Ø¬Ø¯ÙŠØ¯</button>
                <div class="loader" id="borrow-loader"></div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ØµÙˆØ±Ø©</th>
                                <th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
                                <th>Ø§Ù„ØªØµÙ†ÙŠÙ</th>
                                <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="borrow-table-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="share-section" class="content-section">
                <h2 class="section-title">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ§Øª</h2>
                <div class="loader" id="share-loader"></div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Ø§Ù„ØµÙˆØ±Ø©</th>
                                <th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
                                <th>Ø§Ù„ÙˆØµÙ</th>
                                <th>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</th>
                                <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="share-table-body"></tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <div id="book-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header" id="modal-title">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒØªØ§Ø¨</div>
            
            <input type="hidden" id="edit-row-number">
            <input type="hidden" id="current-mode"> 
            
            <input type="text" id="book-title" class="form-input" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØªØ§Ø¨">
            
            <div id="price-container">
                <input type="text" id="book-price" class="form-input" placeholder="Ø§Ù„Ø³Ø¹Ø± (Ù…Ø«Ø§Ù„: 5.00 JD)">
            </div>
            
            <div id="desc-container">
                <textarea id="book-desc" class="form-input" placeholder="ÙˆØµÙ Ø§Ù„ÙƒØªØ§Ø¨" rows="3"></textarea>
            </div>

            <div id="category-container">
                <select id="book-category" class="form-input" style="height: 48px; background: white;">
                    <option value="" disabled selected>Ø§Ø®ØªØ± Ø§Ù„ØªØµÙ†ÙŠÙ</option>
                    <option value="novels">Ø§Ù„Ø±ÙˆØ§ÙŠØ§Øª ÙˆØ§Ù„Ø£Ø¯Ø¨</option>
                    <option value="self-dev">Ø§Ù„ØªÙ†Ù…ÙŠØ© Ø§Ù„Ø¨Ø´Ø±ÙŠØ©</option>
                    <option value="history">Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ø­Ø¶Ø§Ø±Ø©</option>
                    <option value="kids">Ø±ÙƒÙ† Ø§Ù„Ø·ÙÙ„</option>
                    <option value="science">Ø§Ù„Ø¹Ù„ÙˆÙ… ÙˆØ§Ù„Ù…Ø¹Ø±ÙØ©</option>
                    <option value="psychology">Ø¹Ù„Ù… Ø§Ù„Ù†ÙØ³</option>
                    <option value="philosophy">ÙÙ„Ø³ÙØ©</option>
                    <option value="spirituality">Ø±ÙˆØ­Ø§Ù†ÙŠØ§Øª</option>
                    <option value="short-stories">Ù‚ØµØµ Ù‚ØµÙŠØ±Ø©</option>
                    <option value="biography">Ø³ÙŠØ±Ø© Ø°Ø§ØªÙŠØ©</option>
                    <option value="poetry">Ø´Ø¹Ø±</option>
                </select>
            </div>

            <div id="phone-container" style="display:none;">
                <input type="text" id="book-phone" class="form-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
            </div>

            <input type="text" id="book-image" class="form-input" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© (URL)">
            
            <div class="modal-footer">
                <button class="login-btn" id="save-book-btn" onclick="saveBook()">Ø­ÙØ¸</button>
                <button class="login-btn cancel-btn" onclick="closeBookModal()">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <script>
        const scriptURL = 'https://script.google.com/macros/s/AKfycbyAoLZIBPhciqPs5VcVVPDP9pIKDQ4N4hTkolCIt0UPSDHFQOaQZi9zq9XHkmBnsb7cMg/exec';

        const admins = {
            "laitharabiat": "Id6.Pure+",
            "Yara": "read.club"
        };

        let isEditing = false;

        // --- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ---
        function checkLogin() {
            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value;
            const errorMsg = document.getElementById('login-error');

            if (admins[user] && admins[user] === pass) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('dashboard').style.display = 'flex';
                fetchOrders();
            } else {
                errorMsg.style.display = 'block';
            }
        }

        function logout() { location.reload(); }

        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
            document.getElementById(sectionId + '-section').classList.add('active');
            event.currentTarget.classList.add('active');

            if (sectionId === 'books') fetchBooks('books');
            else if (sectionId === 'borrow') fetchBooks('borrow');
            else if (sectionId === 'share') fetchShareBooks();
            else if (sectionId === 'orders') fetchOrders();
        }

        // --- Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ---
        function fetchOrders() {
            const loader = document.getElementById('orders-loader');
            const tbody = document.getElementById('orders-table-body');
            loader.style.display = 'block'; tbody.innerHTML = '';

            fetch(scriptURL + "?action=getOrders")
            .then(response => response.json())
            .then(data => {
                loader.style.display = 'none';
                if (!data || data.length <= 1) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</td></tr>';
                    return;
                }
                const rows = data.slice(1).reverse();
                rows.forEach(row => {
                    const date = new Date(row[0]).toLocaleDateString('ar-JO');
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td data-label="Ø§Ù„ØªØ§Ø±ÙŠØ®">${date}</td>
                        <td data-label="Ø§Ù„Ø§Ø³Ù…">${row[1]}</td>
                        <td data-label="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" style="direction:ltr; text-align:right">${row[2]}</td>
                        <td data-label="Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠ">${row[3]}</td>
                        <td data-label="Ø§Ù„ÙƒØªØ¨ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©">${row[4]}</td>
                        <td data-label="Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ" style="color:#a17506; font-weight:bold">${row[5]}</td>
                    `;
                    tbody.appendChild(tr);
                });
            });
        }

        function fetchBooks(type) {
            const action = type === 'books' ? 'getBooks' : 'getBorrowBooks';
            const loader = document.getElementById(type === 'books' ? 'books-loader' : 'borrow-loader');
            const tbody = document.getElementById(type === 'books' ? 'books-table-body' : 'borrow-table-body');
            
            loader.style.display = 'block';
            tbody.innerHTML = '';

            fetch(scriptURL + "?action=" + action)
            .then(response => response.json())
            .then(data => {
                loader.style.display = 'none';
                
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 20px;">Ø§Ù„Ù…ÙƒØªØ¨Ø© ÙØ§Ø±ØºØ©</td></tr>';
                    return;
                }

                data.forEach(book => {
                    const tr = document.createElement('tr');
                    const bookData = encodeURIComponent(JSON.stringify(book));
                    const priceCell = type === 'books' ? `<td data-label="Ø§Ù„Ø³Ø¹Ø±">${book.price}</td>` : '';
                    
                    tr.innerHTML = `
                        <td data-label="Ø§Ù„ØµÙˆØ±Ø©"><img src="${book.image}" width="50" height="75" style="object-fit:cover; border-radius:6px;"></td>
                        <td data-label="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†" style="font-weight:600">${book.title}</td>
                        ${priceCell}
                        <td data-label="Ø§Ù„ØªØµÙ†ÙŠÙ">${book.category}</td>
                        <td data-label="Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª">
                            <button class="action-btn btn-edit" onclick="openEditBookModal('${bookData}', '${type}')">ØªØ¹Ø¯ÙŠÙ„</button>
                            <button class="action-btn btn-delete" onclick="deleteBook(${book.rowNumber}, '${type}')">Ø­Ø°Ù</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            });
        }

        function fetchShareBooks() {
            const loader = document.getElementById('share-loader');
            const tbody = document.getElementById('share-table-body');
            
            loader.style.display = 'block';
            tbody.innerHTML = '';

            fetch(scriptURL + "?action=getShareBooks")
            .then(response => response.json())
            .then(data => {
                loader.style.display = 'none';
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙƒØ§Øª</td></tr>';
                    return;
                }

                data.forEach(item => {
                    const itemData = encodeURIComponent(JSON.stringify(item));
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td data-label="Ø§Ù„ØµÙˆØ±Ø©"><img src="${item.image}" width="50" height="75" style="object-fit:cover; border-radius:6px;"></td>
                        <td data-label="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†" style="font-weight:600">${item.title}</td>
                        <td data-label="Ø§Ù„ÙˆØµÙ" style="max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${item.description}</td>
                        <td data-label="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" style="direction:ltr;">${item.phone}</td>
                        <td data-label="Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª">
                            <button class="action-btn btn-edit" onclick="openEditBookModal('${itemData}', 'share')">ØªØ¹Ø¯ÙŠÙ„</button>
                            <button class="action-btn btn-delete" onclick="deleteBook(${item.rowNumber}, 'share')">Ø­Ø°Ù</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            });
        }

        // --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†ÙˆØ§ÙØ° (Modal) ---
        function openAddBookModal(mode) {
            isEditing = false;
            document.getElementById('current-mode').value = mode;
            document.getElementById('modal-title').innerText = mode === 'sale' ? "Ø¥Ø¶Ø§ÙØ© ÙƒØªØ§Ø¨ Ù„Ù„Ø¨ÙŠØ¹" : "Ø¥Ø¶Ø§ÙØ© ÙƒØªØ§Ø¨ Ù„Ù„Ø§Ø³ØªØ¹Ø§Ø±Ø©";
            
            document.getElementById('price-container').style.display = mode === 'sale' ? 'block' : 'none';
            document.getElementById('desc-container').style.display = mode === 'sale' ? 'block' : 'none';
            document.getElementById('category-container').style.display = 'block';
            document.getElementById('phone-container').style.display = 'none';

            document.getElementById('book-title').value = '';
            document.getElementById('book-price').value = '';
            document.getElementById('book-category').value = '';
            document.getElementById('book-desc').value = '';
            document.getElementById('book-image').value = '';
            document.getElementById('edit-row-number').value = '';
            
            document.getElementById('book-modal').style.display = 'flex';
        }

        function openEditBookModal(bookDataStr, type) {
            isEditing = true;
            const book = JSON.parse(decodeURIComponent(bookDataStr));
            const mode = type === 'books' ? 'sale' : (type === 'borrow' ? 'borrow' : 'share');
            
            document.getElementById('current-mode').value = mode;
            document.getElementById('modal-title').innerText = "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª";
            document.getElementById('edit-row-number').value = book.rowNumber;
            
            document.getElementById('book-title').value = book.title;
            document.getElementById('book-image').value = book.image;

            if(mode === 'sale') {
                document.getElementById('price-container').style.display = 'block';
                document.getElementById('book-price').value = book.price;
                document.getElementById('desc-container').style.display = 'block';
                document.getElementById('book-desc').value = book.description || '';
                document.getElementById('category-container').style.display = 'block';
                document.getElementById('book-category').value = book.category;
                document.getElementById('phone-container').style.display = 'none';
            } else if (mode === 'borrow') {
                document.getElementById('price-container').style.display = 'none';
                document.getElementById('desc-container').style.display = 'none';
                document.getElementById('category-container').style.display = 'block';
                document.getElementById('book-category').value = book.category;
                document.getElementById('phone-container').style.display = 'none';
            } else if (mode === 'share') {
                document.getElementById('price-container').style.display = 'none';
                document.getElementById('category-container').style.display = 'none';
                document.getElementById('desc-container').style.display = 'block';
                document.getElementById('book-desc').value = book.description || '';
                document.getElementById('phone-container').style.display = 'block';
                document.getElementById('book-phone').value = book.phone;
            }
            
            document.getElementById('book-modal').style.display = 'flex';
        }

        function closeBookModal() {
            document.getElementById('book-modal').style.display = 'none';
        }

        // --- Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ---
        function saveBook() {
            const mode = document.getElementById('current-mode').value;
            const btn = document.getElementById('save-book-btn');
            const rowNumber = document.getElementById('edit-row-number').value;

            let action = '';
            if(mode === 'sale') action = isEditing ? 'editBook' : 'addBook';
            else if(mode === 'borrow') action = isEditing ? 'editBorrowBook' : 'addBorrowBook';
            else if(mode === 'share') action = 'editShareBook';

            const formData = {
                action: action,
                rowNumber: rowNumber,
                title: document.getElementById('book-title').value,
                image: document.getElementById('book-image').value
            };

            if(mode === 'sale') {
                formData.price = document.getElementById('book-price').value;
                formData.category = document.getElementById('book-category').value;
                formData.description = document.getElementById('book-desc').value;
            } else if (mode === 'borrow') {
                formData.category = document.getElementById('book-category').value;
            } else if (mode === 'share') {
                formData.description = document.getElementById('book-desc').value;
                formData.phone = document.getElementById('book-phone').value;
            }

            btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...";
            btn.disabled = true;

            fetch(scriptURL, {
                method: 'POST',
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                body: JSON.stringify(formData)
            })
            .then(res => res.text())
            .then(text => {
                alert("ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­");
                closeBookModal();
                if(mode === 'share') fetchShareBooks();
                else fetchBooks(mode === 'sale' ? 'books' : 'borrow');
            })
            .catch(err => {
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£!");
                console.error(err);
            })
            .finally(() => {
                btn.innerText = "Ø­ÙØ¸";
                btn.disabled = false;
            });
        }

        function deleteBook(rowNumber, type) {
            if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ")) {
                let action = '';
                if(type === 'books') action = 'deleteBook';
                else if(type === 'borrow') action = 'deleteBorrowBook';
                else if(type === 'share') action = 'deleteShareBook';

                fetch(scriptURL, {
                    method: 'POST',
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify({action: action, rowNumber: rowNumber})
                })
                .then(res => res.text())
                .then(text => {
                    alert("ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­");
                    if(type === 'share') fetchShareBooks();
                    else fetchBooks(type);
                });
            }
        }

    </script>
</body>
</html>
